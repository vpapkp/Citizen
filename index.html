<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Advanced U.S. Civics Flashcards (Texas)</title>
    <style>
        :root {
            --flagged-color: #ffc107; /* Orange */
            --correct-color: #28a745; /* Green */
            --incorrect-color: #dc3545; /* Red */
            --default-border: transparent;
        }
        * {
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #f0f2f5;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            color: #333;
            padding: 10px 0;
        }
        .container {
            width: 95%;
            max-width: 600px;
            text-align: center;
        }
        h1 {
            font-size: 1.6em;
            margin-top: 0;
            margin-bottom: 10px;
        }
        #progress-stats {
            margin-bottom: 15px;
            font-size: 1em;
            font-weight: 500;
            color: #555;
        }
        #progress-stats .correct-text { color: var(--correct-color); }
        #progress-stats .incorrect-text { color: var(--incorrect-color); }
        .card-container {
            perspective: 1000px;
            margin-bottom: 15px;
        }
        .card {
            width: 100%;
            height: 380px;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.6s;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            border-radius: 15px;
            border-left: 5px solid var(--default-border);
        }
        .card.is-flagged { border-left-color: var(--flagged-color); }
        .card.is-correct { border-left-color: var(--correct-color); }
        .card.is-incorrect { border-left-color: var(--incorrect-color); }
        
        .card.is-flipped {
            transform: rotateY(180deg);
        }
        .card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
            border-radius: 15px;
            background-color: #ffffff;
        }
        .card-face-front .top-controls {
            position: absolute;
            top: 15px;
            right: 15px;
            display: flex;
            gap: 10px;
        }
        .icon-button {
             background: #f0f2f5;
            border: 1px solid #ccc;
            border-radius: 5px;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 0.9em;
        }
        #flag-button.active {
            background-color: var(--flagged-color);
            color: white;
            border-color: var(--flagged-color);
        }
        .card-face-back {
            transform: rotateY(180deg);
            background-color: #f8f9fa;
        }
        .card-face-back .bottom-controls {
            position: absolute;
            bottom: 20px;
            width: 100%;
            display: flex;
            justify-content: space-around;
        }
        .status-button {
            width: 100px;
            padding: 10px;
            font-size: 0.9em;
            border: none;
            color: white;
            border-radius: 5px;
            cursor: pointer;
        }
        .correct-button { background-color: var(--correct-color); }
        .incorrect-button { background-color: var(--incorrect-color); }
        .question-title {
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 10px;
        }
        #speech-status {
            font-style: italic;
            color: #6c757d;
            height: 20px;
            margin-bottom: 5px;
        }
        .answer-title {
            font-size: 1.3em;
            font-weight: bold;
            color: #007bff;
        }
        .content {
            font-size: 1.1em;
            line-height: 1.5;
            overflow-y: auto;
        }
        .answer-content ul { list-style-type: none; padding: 0; margin: 0; }
        .answer-content li { 
            margin-bottom: 8px;
        }
        .navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .nav-button {
            padding: 8px 12px;
            font-size: 0.9em;
            cursor: pointer;
            border: none;
            background-color: #007bff;
            color: white;
            border-radius: 5px;
            white-space: nowrap;
        }
        #question-select {
            padding: 8px;
            font-size: 0.9em;
            border-radius: 5px;
            border: 1px solid #ced4da;
            flex-grow: 1; 
            margin: 0 5px;
        }
        .summary-section {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-top: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: left;
            display: none;
        }
        .summary-section h2 { margin-top: 0; }
        .summary-list {
            list-style: none;
            padding: 0;
            max-height: 150px;
            overflow-y: auto;
        }
        .summary-list li {
            padding: 8px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }
        .summary-list li:hover { background-color: #f0f2f5; }
        .bottom-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        .bottom-actions button {
            flex-grow: 1;
        }
        #voice-mode-button.active {
            background-color: var(--correct-color);
        }
        .note { font-style: italic; font-size: 0.9em; color: #6c757d; }
    </style>
</head>
<body>

<div class="container">
    <h1>Civics Flashcards (TX)</h1>
    <div id="progress-stats">
        <span>Completed: <span id="completed-count">0</span>/100</span> |
        <span class="correct-text">Correct: <span id="correct-count">0</span></span> |
        <span class="incorrect-text">Wrong: <span id="wrong-count">0</span></span>
    </div>
    <div class="card-container">
        <div class="card" id="card">
            <div class="card-face card-face-front">
                <div class="top-controls">
                    <button class="icon-button" id="listen-button">üéôÔ∏è</button>
                    <button class="icon-button" id="flag-button">üö©</button>
                </div>
                <div class="question-title" id="question-title"></div>
                <div class="content" id="question-text"></div>
                <div id="speech-status"></div>
            </div>
            <div class="card-face card-face-back">
                <div class="answer-title">Answer</div>
                <div class="content answer-content" id="answer-text"></div>
                <div class="bottom-controls">
                    <button class="status-button incorrect-button" data-status="incorrect">Incorrect</button>
                    <button class="status-button correct-button" data-status="correct">Correct</button>
                </div>
            </div>
        </div>
    </div>
    <div class="navigation">
        <button class="nav-button" id="prev-button">Previous</button>
        <select id="question-select"></select>
        <button class="nav-button" id="next-button">Next</button>
    </div>
    <div class="bottom-actions">
        <button class="nav-button" id="review-button" style="background-color: #ffc107; color: black;">Review Flagged</button>
        <button class="nav-button" id="voice-mode-button">üîä Voice Mode</button>
        <button class="nav-button" id="summary-toggle-button" style="background-color: #6c757d;">Summary</button>
    </div>
    <div class="summary-section" id="summary-section">
        <h2>Review Summary</h2>
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <p style="margin: 0;">Cards to review.</p>
            <button id="reset-button" style="background-color: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 5px;">Reset All</button>
        </div>
        <h4>üö© Flagged for Review</h4>
        <ul class="summary-list" id="flagged-list"><li>None</li></ul>
        <h4>‚ùå Marked Incorrect</h4>
        <ul class="summary-list" id="incorrect-list"><li>None</li></ul>
    </div>
</div>

<script>
    const flashcards = [
        { q: "What is the supreme law of the land?", a: ["the Constitution"], keywords: ["constitution"] },
        { q: "What does the Constitution do?", a: ["sets up the government", "defines the government", "protects basic rights of Americans"], keywords: ["sets", "defines", "government", "protects", "rights"] },
        { q: "The idea of self-government is in the first three words of the Constitution. What are these words?", a: ["We the People"], keywords: ["we the people"] },
        { q: "What is an amendment?", a: ["a change (to the Constitution)", "an addition (to the Constitution)"], keywords: ["change", "addition"] },
        { q: "What do we call the first ten amendments to the Constitution?", a: ["the Bill of Rights"], keywords: ["bill of rights"] },
        { q: "What is one right or freedom from the First Amendment?*", a: ["speech", "religion", "assembly", "press", "petition the government"], keywords: ["speech", "religion", "assembly", "press", "petition"] },
        { q: "How many amendments does the Constitution have?", a: ["twenty-seven (27)"], keywords: ["27", "twenty-seven", "twenty seven"] },
        { q: "What did the Declaration of Independence do?", a: ["announced our independence (from Great Britain)"], keywords: ["announced", "declared", "independence", "free"] },
        { q: "What are two rights in the Declaration of Independence?", a: ["life", "liberty", "pursuit of happiness"], keywords: ["life", "liberty", "happiness"] },
        { q: "What is freedom of religion?", a: ["You can practice any religion, or not practice a religion."], keywords: ["practice any religion", "not practice"] },
        { q: "What is the economic system in the United States?*", a: ["capitalist economy", "market economy"], keywords: ["capitalist", "market"] },
        { q: "What is the 'rule of law'?", a: ["Everyone must follow the law.", "No one is above the law."], keywords: ["everyone must follow", "no one is above"] },
        { q: "Name one branch or part of the government.*", a: ["Congress", "President (executive)", "the courts (judicial)"], keywords: ["congress", "president", "executive", "courts", "judicial", "legislative"] },
        { q: "What stops one branch of government from becoming too powerful?", a: ["checks and balances", "separation of powers"], keywords: ["checks", "balances", "separation", "powers"] },
        { q: "Who is in charge of the executive branch?", a: ["the President"], keywords: ["president"] },
        { q: "Who makes federal laws?", a: ["Congress", "Senate and House of Representatives"], keywords: ["congress", "senate", "house", "legislature"] },
        { q: "What are the two parts of the U.S. Congress?*", a: ["the Senate and House (of Representatives)"], keywords: ["senate", "house"] },
        { q: "How many U.S. Senators are there?", a: ["one hundred (100)"], keywords: ["100", "one hundred"] },
        { q: "We elect a U.S. Senator for how many years?", a: ["six (6)"], keywords: ["6", "six"] },
        { q: "Who is one of your state's U.S. Senators now?*", a: ["John Cornyn", "Ted Cruz"], keywords: ["cornyn", "cruz"] },
        { q: "The House of Representatives has how many voting members?", a: ["four hundred thirty-five (435)"], keywords: ["435", "four hundred thirty-five", "four thirty-five"] },
        { q: "We elect a U.S. Representative for how many years?", a: ["two (2)"], keywords: ["2", "two"] },
        { q: "Name your U.S. Representative.", a: ["Keith Self"], keywords: ["keith", "self"] },
        { q: "Who does a U.S. Senator represent?", a: ["all people of the state"], keywords: ["all people", "of the state"] },
        { q: "Why do some states have more Representatives than other states?", a: ["(because of) the state's population"], keywords: ["population", "more people"] },
        { q: "We elect a President for how many years?", a: ["four (4)"], keywords: ["4", "four"] },
        { q: "In what month do we vote for President?*", a: ["November"], keywords: ["november"] },
        { q: "What is the name of the President of the United States now?*", a: ["Donald Trump"], keywords: ["donald", "trump"] },
        { q: "What is the name of the Vice President of the United States now?", a: ["J. D. Vance"], keywords: ["jd", "vance"] },
        { q: "If the President can no longer serve, who becomes President?", a: ["the Vice President"], keywords: ["vice president"] },
        { q: "If both the President and the Vice President can no longer serve, who becomes President?", a: ["the Speaker of the House"], keywords: ["speaker", "house"] },
        { q: "Who is the Commander in Chief of the military?", a: ["the President"], keywords: ["president"] },
        { q: "Who signs bills to become laws?", a: ["the President"], keywords: ["president"] },
        { q: "Who vetoes bills?", a: ["the President"], keywords: ["president"] },
        { q: "What does the President's Cabinet do?", a: ["advises the President"], keywords: ["advises"] },
        { q: "What are two Cabinet-level positions?", a: ["Secretary of Defense", "Secretary of Education", "Secretary of State", "Attorney General", "Vice President"], keywords: ["defense", "education", "state", "attorney general", "vice president", "agriculture", "commerce", "energy", "labor", "treasury"] },
        { q: "What does the judicial branch do?", a: ["reviews laws", "explains laws", "resolves disputes", "decides if a law goes against the Constitution"], keywords: ["reviews", "explains", "resolves", "decides"] },
        { q: "What is the highest court in the United States?", a: ["the Supreme Court"], keywords: ["supreme court"] },
        { q: "How many justices are on the Supreme Court?", a: ["Nine (9)"], keywords: ["9", "nine"] },
        { q: "Who is the Chief Justice of the United States now?", a: ["John G. Roberts, Jr."], keywords: ["john roberts", "roberts"] },
        { q: "Under our Constitution, some powers belong to the federal government. What is one power of the federal government?", a: ["to print money", "to declare war", "to create an army", "to make treaties"], keywords: ["print money", "declare war", "create army", "make treaties"] },
        { q: "Under our Constitution, some powers belong to the states. What is one power of the states?", a: ["provide schooling and education", "provide protection (police)", "give a driver's license"], keywords: ["schooling", "education", "police", "protection", "safety", "driver's license"] },
        { q: "Who is the Governor of your state now?", a: ["Greg Abbott"], keywords: ["greg", "abbott"] },
        { q: "What is the capital of your state?*", a: ["Austin"], keywords: ["austin"] },
        { q: "What are the two major political parties in the United States?*", a: ["Democratic and Republican"], keywords: ["democratic", "republican"] },
        { q: "What is the political party of the President now?", a: ["Republican Party"], keywords: ["republican"] },
        { q: "What is the name of the Speaker of the House of Representatives now?", a: ["Mike Johnson"], keywords: ["mike", "johnson"] },
        { q: "There are four amendments to the Constitution about who can vote. Describe one of them.", a: ["Citizens eighteen (18) and older can vote.", "You don't have to pay a poll tax to vote.", "Any citizen can vote.", "A male citizen of any race can vote."], keywords: ["eighteen", "18", "poll tax", "any citizen", "male citizen"] },
        { q: "What is one responsibility that is only for United States citizens?*", a: ["serve on a jury", "vote in a federal election"], keywords: ["jury", "vote"] },
        { q: "Name one right only for United States citizens.", a: ["vote in a federal election", "run for federal office"], keywords: ["vote", "run for office"] },
        { q: "What are two rights of everyone living in the United States?", a: ["freedom of expression", "freedom of speech", "freedom of assembly", "freedom of religion", "the right to bear arms"], keywords: ["expression", "speech", "assembly", "religion", "bear arms"] },
        { q: "What do we show loyalty to when we say the Pledge of Allegiance?", a: ["the United States", "the flag"], keywords: ["united states", "flag"] },
        { q: "What is one promise you make when you become a United States citizen?", a: ["give up loyalty", "defend the Constitution", "obey the laws", "serve in the military"], keywords: ["loyalty", "defend", "obey", "serve"] },
        { q: "How old do citizens have to be to vote for President?*", a: ["eighteen (18) and older"], keywords: ["18", "eighteen"] },
        { q: "What are two ways that Americans can participate in their democracy?", a: ["vote", "join a political party", "help with a campaign", "run for office"], keywords: ["vote", "join party", "campaign", "run for office", "call senators"] },
        { q: "When is the last day you can send in federal income tax forms?*", a: ["April 15"], keywords: ["april 15", "april fifteenth"] },
        { q: "When must all men register for the Selective Service?", a: ["at age eighteen (18)", "between eighteen (18) and twenty-six (26)"], keywords: ["18", "eighteen", "26", "twenty-six"] },
        { q: "What is one reason colonists came to America?", a: ["freedom", "political liberty", "religious freedom", "economic opportunity", "escape persecution"], keywords: ["freedom", "liberty", "religious", "economic", "persecution"] },
        { q: "Who lived in America before the Europeans arrived?", a: ["American Indians", "Native Americans"], keywords: ["american indians", "native americans"] },
        { q: "What group of people was taken to America and sold as slaves?", a: ["Africans", "people from Africa"], keywords: ["africans", "africa"] },
        { q: "Why did the colonists fight the British?", a: ["because of high taxes (taxation without representation)", "because they didn't have self-government"], keywords: ["high taxes", "taxation without representation", "self-government"] },
        { q: "Who wrote the Declaration of Independence?", a: ["(Thomas) Jefferson"], keywords: ["jefferson"] },
        { q: "When was the Declaration of Independence adopted?", a: ["July 4, 1776"], keywords: ["july 4 1776"] },
        { q: "There were 13 original states. Name three.", a: ["New Hampshire", "Massachusetts", "New York", "Virginia", "Maryland"], keywords: ["hampshire", "massachusetts", "york", "virginia", "maryland", "carolina", "georgia", "jersey", "pennsylvania", "delaware", "connecticut", "rhode island"] },
        { q: "What happened at the Constitutional Convention?", a: ["The Constitution was written."], keywords: ["constitution was written"] },
        { q: "When was the Constitution written?", a: ["1787"], keywords: ["1787"] },
        { q: "The Federalist Papers supported the passage of the U.S. Constitution. Name one of the writers.", a: ["(James) Madison", "(Alexander) Hamilton", "(John) Jay"], keywords: ["madison", "hamilton", "jay", "publius"] },
        { q: "What is one thing Benjamin Franklin is famous for?", a: ["U.S. diplomat", "oldest member of the Constitutional Convention", "first Postmaster General", "writer of 'Poor Richard's Almanac'"], keywords: ["diplomat", "oldest member", "postmaster", "poor richard", "libraries"] },
        { q: "Who is the 'Father of Our Country'?", a: ["(George) Washington"], keywords: ["george washington", "washington"] },
        { q: "Who was the first President?*", a: ["(George) Washington"], keywords: ["george washington", "washington"] },
        { q: "What territory did the United States buy from France in 1803?", a: ["the Louisiana Territory"], keywords: ["louisiana"] },
        { q: "Name one war fought by the United States in the 1800s.", a: ["War of 1812", "Mexican-American War", "Civil War", "Spanish-American War"], keywords: ["1812", "mexican", "civil", "spanish"] },
        { q: "Name the U.S. war between the North and the South.", a: ["the Civil War", "the War between the States"], keywords: ["civil war", "war between states"] },
        { q: "Name one problem that led to the Civil War.", a: ["slavery", "economic reasons", "states' rights"], keywords: ["slavery", "economic", "states' rights"] },
        { q: "What was one important thing that Abraham Lincoln did?*", a: ["freed the slaves (Emancipation Proclamation)", "saved (or preserved) the Union", "led the United States during the Civil War"], keywords: ["freed slaves", "emancipation", "saved union", "led during civil war"] },
        { q: "What did the Emancipation Proclamation do?", a: ["freed the slaves"], keywords: ["freed slaves"] },
        { q: "What did Susan B. Anthony do?", a: ["fought for women's rights", "fought for civil rights"], keywords: ["women's rights", "civil rights"] },
        { q: "Name one war fought by the United States in the 1900s.*", a: ["World War I", "World War II", "Korean War", "Vietnam War", "(Persian) Gulf War"], keywords: ["world war one", "world war 1", "world war two", "world war 2", "korean", "vietnam", "gulf"] },
        { q: "Who was President during World War I?", a: ["(Woodrow) Wilson"], keywords: ["woodrow wilson", "wilson"] },
        { q: "Who was President during the Great Depression and World War II?", a: ["(Franklin) Roosevelt"], keywords: ["franklin roosevelt", "roosevelt"] },
        { q: "Who did the United States fight in World War II?", a: ["Japan, Germany, and Italy"], keywords: ["japan", "germany", "italy"] },
        { q: "Before he was President, Eisenhower was a general. What war was he in?", a: ["World War II"], keywords: ["world war two", "world war 2", "wwii"] },
        { q: "During the Cold War, what was the main concern of the United States?", a: ["Communism"], keywords: ["communism"] },
        { q: "What movement tried to end racial discrimination?", a: ["civil rights (movement)"], keywords: ["civil rights"] },
        { q: "What did Martin Luther King, Jr. do?*", a: ["fought for civil rights", "worked for equality for all Americans"], keywords: ["civil rights", "equality"] },
        { q: "What major event happened on September 11, 2001, in the United States?", a: ["Terrorists attacked the United States."], keywords: ["terrorists attacked", "september 11", "9/11"] },
        { q: "Name one American Indian tribe in the United States.", a: ["Cherokee", "Navajo", "Sioux", "Chippewa", "Choctaw", "Pueblo", "Apache"], keywords: ["cherokee", "navajo", "sioux", "chippewa", "choctaw", "pueblo", "apache"] },
        { q: "Name one of the two longest rivers in the United States.", a: ["Missouri (River)", "Mississippi (River)"], keywords: ["missouri", "mississippi"] },
        { q: "What ocean is on the West Coast of the United States?", a: ["Pacific (Ocean)"], keywords: ["pacific"] },
        { q: "What ocean is on the East Coast of the United States?", a: ["Atlantic (Ocean)"], keywords: ["atlantic"] },
        { q: "Name one U.S. territory.", a: ["Puerto Rico", "U.S. Virgin Islands", "Guam"], keywords: ["puerto rico", "virgin islands", "guam", "samoa", "mariana"] },
        { q: "Name one state that borders Canada.", a: ["Maine", "New York", "Washington", "Alaska"], keywords: ["maine", "york", "washington", "alaska", "montana", "minnesota", "dakota", "idaho", "vermont", "hampshire"] },
        { q: "Name one state that borders Mexico.", a: ["California", "Arizona", "New Mexico", "Texas"], keywords: ["california", "arizona", "new mexico", "texas"] },
        { q: "What is the capital of the United States?*", a: ["Washington, D.C."], keywords: ["washington dc", "dc"] },
        { q: "Where is the Statue of Liberty?*", a: ["New York (Harbor)", "Liberty Island"], keywords: ["new york", "liberty island", "hudson"] },
        { q: "Why does the flag have 13 stripes?", a: ["because there were 13 original colonies"], keywords: ["13", "thirteen", "colonies"] },
        { q: "Why does the flag have 50 stars?*", a: ["because there is one star for each state"], keywords: ["50", "fifty", "star for each state"] },
        { q: "What is the name of the national anthem?", a: ["The Star-Spangled Banner"], keywords: ["star-spangled banner", "star spangled banner"] },
        { q: "When do we celebrate Independence Day?*", a: ["July 4"], keywords: ["july 4", "july fourth"] },
        { q: "Name two national U.S. holidays.", a: ["New Year's Day", "Martin Luther King, Jr. Day", "Presidents' Day", "Memorial Day", "Independence Day", "Labor Day", "Thanksgiving", "Christmas"], keywords: ["new year's", "martin luther king", "presidents", "memorial", "independence", "labor", "thanksgiving", "christmas", "veterans", "columbus"] },
    ];

    document.addEventListener('DOMContentLoaded', () => {
        
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition;

        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.lang = 'en-US';
            recognition.interimResults = false;
            recognition.maxAlternatives = 1;
        } else {
            console.log("Speech Recognition Not Supported");
            const voiceModeButton = document.getElementById('voice-mode-button');
            if(voiceModeButton) voiceModeButton.style.display = 'none';
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }
        
        shuffleArray(flashcards);

        let currentCard = 0;
        let reviewMode = false;
        let flaggedIndices = [];
        let currentReviewIndex = 0;
        let isVoiceModeActive = false;

        flashcards.forEach(card => {
            card.isFlagged = false;
            card.status = 'unanswered';
        });
        
        const originalOrder = [...flashcards].sort((a,b) => (a.q > b.q ? 1 : -1));

        const cardElement = document.getElementById('card');
        const questionTitle = document.getElementById('question-title');
        const questionText = document.getElementById('question-text');
        const speechStatus = document.getElementById('speech-status');
        const answerText = document.getElementById('answer-text');
        const prevButton = document.getElementById('prev-button');
        const nextButton = document.getElementById('next-button');
        const questionSelect = document.getElementById('question-select');
        const flagButton = document.getElementById('flag-button');
        const listenButton = document.getElementById('listen-button');
        const correctButton = document.querySelector('.correct-button');
        const incorrectButton = document.querySelector('.incorrect-button');
        const summaryToggleButton = document.getElementById('summary-toggle-button');
        const summarySection = document.getElementById('summary-section');
        const flaggedList = document.getElementById('flagged-list');
        const incorrectList = document.getElementById('incorrect-list');
        const resetButton = document.getElementById('reset-button');
        const reviewButton = document.getElementById('review-button');
        const voiceModeButton = document.getElementById('voice-mode-button');
        const completedCountEl = document.getElementById('completed-count');
        const correctCountEl = document.getElementById('correct-count');
        const wrongCountEl = document.getElementById('wrong-count');

        function speak(text, callback) {
            if (!('speechSynthesis' in window)) {
                if(callback) callback();
                return;
            }
            speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(text.replace(/\*/g, ''));
            utterance.onend = () => {
                if (callback) callback();
            };
            window.speechSynthesis.speak(utterance);
        }

        function startVoiceInteraction() {
            if (!isVoiceModeActive || cardElement.classList.contains('is-flipped')) return;
            const question = flashcards[currentCard].q;
            speak(question, () => {
                if (isVoiceModeActive && recognition) {
                    try {
                        recognition.start();
                    } catch(e) {
                        console.error("Recognition start error:", e);
                        speechStatus.textContent = "Mic busy. Try again.";
                    }
                }
            });
        }

        function updateStats() {
            let completed = 0, correct = 0, incorrect = 0;
            flashcards.forEach(card => {
                if (card.status === 'correct') { correct++; completed++; }
                else if (card.status === 'incorrect') { incorrect++; completed++; }
            });
            completedCountEl.textContent = completed;
            correctCountEl.textContent = correct;
            wrongCountEl.textContent = incorrect;
        }

        function updateCardUI(index) {
            const card = flashcards[index];
            cardElement.className = 'card';
            if (cardElement.classList.contains('is-flipped')) cardElement.classList.add('is-flipped');
            if (card.isFlagged) cardElement.classList.add('is-flagged');
            if (card.status === 'correct') cardElement.classList.add('is-correct');
            else if (card.status === 'incorrect') cardElement.classList.add('is-incorrect');
            flagButton.classList.toggle('active', card.isFlagged);
        }

        function showCard(index) {
            cardElement.classList.remove('is-flipped');
            speechStatus.textContent = '';
            const question = flashcards[index];
            const originalIndex = originalOrder.findIndex(c => c.q === question.q);
            questionTitle.textContent = `Question ${originalIndex + 1}`;
            questionText.innerHTML = question.q;
            let answerHtml = '<ul>';
            question.a.forEach(ans => { answerHtml += `<li>${ans}</li>`; });
            answerHtml += '</ul>';
            answerText.innerHTML = answerHtml;
            questionSelect.value = index;
            updateCardUI(index);
        }

        function populateSelect() {
            questionSelect.innerHTML = '';
            const sortedForSelect = [...flashcards].map((card, index) => {
                const originalIndex = originalOrder.findIndex(c => c.q === card.q);
                return { card, index, originalIndex };
            }).sort((a,b) => a.originalIndex - b.originalIndex);

            sortedForSelect.forEach(item => {
                const option = document.createElement('option');
                option.value = item.index;
                option.textContent = `Question ${item.originalIndex + 1}`;
                questionSelect.appendChild(option);
            });
        }

        function renderSummary() {
            flaggedList.innerHTML = ''; incorrectList.innerHTML = '';
            let flaggedCount = 0, incorrectCount = 0;
            const summaryItems = flashcards.map((card, index) => {
                const originalIndex = originalOrder.findIndex(c => c.q === card.q);
                return { card, index, originalIndex };
            }).sort((a,b) => a.originalIndex - b.originalIndex);

            summaryItems.forEach(item => {
                const li = document.createElement('li');
                li.innerHTML = `Q${item.originalIndex + 1}: ${item.card.q.substring(0, 40)}...`;
                const jumpToCard = () => {
                    if (reviewMode) toggleReviewMode();
                    currentCard = item.index;
                    showCard(currentCard);
                    summarySection.style.display = 'none';
                    summaryToggleButton.textContent = 'Summary';
                };
                if (item.card.isFlagged) {
                    const flaggedLi = li.cloneNode(true);
                    flaggedLi.onclick = jumpToCard;
                    flaggedList.appendChild(flaggedLi);
                    flaggedCount++;
                }
                if (item.card.status === 'incorrect') {
                    const incorrectLi = li.cloneNode(true);
                    incorrectLi.onclick = jumpToCard;
                    incorrectList.appendChild(incorrectLi);
                    incorrectCount++;
                }
            });
            if (flaggedCount === 0) flaggedList.innerHTML = '<li>None</li>';
            if (incorrectCount === 0) incorrectList.innerHTML = '<li>None</li>';
        }

        function setCardStatus(status, verbalFeedback = false) {
            flashcards[currentCard].status = status;
            updateCardUI(currentCard);
            updateStats();
            
            const feedbackText = status === 'correct' ? 'Correct' : 'Incorrect';
            
            if (verbalFeedback && isVoiceModeActive) {
                speak(feedbackText, () => {
                    if (isVoiceModeActive) nextButton.click();
                });
            } else {
                 setTimeout(() => { if (!isVoiceModeActive) nextButton.click(); }, 1200);
            }
        }

        function checkAnswer(transcript) {
            speechStatus.textContent = `I heard: "${transcript}"`;
            const card = flashcards[currentCard];
            const heard = transcript.toLowerCase().trim();
            const isMatch = card.keywords.some(key => heard.includes(key));
            
            setCardStatus(isMatch ? 'correct' : 'incorrect', true);
        }
        
        function toggleReviewMode() {
            reviewMode = !reviewMode;
            if (reviewMode) {
                flaggedIndices = flashcards.map((card, index) => card.isFlagged ? index : -1).filter(index => index !== -1);
                if (flaggedIndices.length === 0) {
                    alert("No cards have been flagged for review.");
                    reviewMode = false; return;
                }
                reviewButton.textContent = 'Exit Review';
                reviewButton.style.backgroundColor = '#dc3545';
                questionSelect.disabled = true;
                currentReviewIndex = 0;
                currentCard = flaggedIndices[currentReviewIndex];
                showCard(currentCard);
            } else {
                reviewButton.textContent = 'Review Flagged';
                reviewButton.style.backgroundColor = '#ffc107';
                questionSelect.disabled = false;
            }
            if (isVoiceModeActive) startVoiceInteraction();
        }
        
        if (recognition) {
            recognition.onstart = () => { speechStatus.textContent = "Listening..."; };
            recognition.onspeechend = () => { recognition.stop();};
            recognition.onresult = (event) => { checkAnswer(event.results[0][0].transcript); };
            recognition.onerror = (event) => { 
                speechStatus.textContent = `Mic error: ${event.error}`;
                if (isVoiceModeActive) { // if still in voice mode, try next card
                    setTimeout(() => nextButton.click(), 2000);
                }
            };
        }

        cardElement.addEventListener('click', (e) => {
            if (!e.target.closest('.top-controls') && !e.target.closest('.bottom-controls')) {
                cardElement.classList.toggle('is-flipped');
            }
        });

        function handleNavigation() {
            speechSynthesis.cancel();
            if (recognition) recognition.stop();
            if (isVoiceModeActive) startVoiceInteraction();
        }

        prevButton.addEventListener('click', () => {
            if (reviewMode) {
                if (flaggedIndices.length === 0) return;
                currentReviewIndex = (currentReviewIndex - 1 + flaggedIndices.length) % flaggedIndices.length;
                currentCard = flaggedIndices[currentReviewIndex];
            } else {
                currentCard = (currentCard - 1 + flashcards.length) % flashcards.length;
            }
            showCard(currentCard);
            handleNavigation();
        });

        nextButton.addEventListener('click', () => {
            if (reviewMode) {
                if (flaggedIndices.length === 0) return;
                currentReviewIndex = (currentReviewIndex + 1) % flaggedIndices.length;
                currentCard = flaggedIndices[currentReviewIndex];
            } else {
                currentCard = (currentCard + 1) % flashcards.length;
            }
            showCard(currentCard);
            handleNavigation();
        });

        questionSelect.addEventListener('change', (e) => {
            currentCard = parseInt(e.target.value);
            showCard(currentCard);
            handleNavigation();
        });

        flagButton.addEventListener('click', (e) => {
            e.stopPropagation();
            flashcards[currentCard].isFlagged = !flashcards[currentCard].isFlagged;
            updateCardUI(currentCard);
        });
        
        correctButton.addEventListener('click', (e) => { e.stopPropagation(); setCardStatus('correct'); });
        incorrectButton.addEventListener('click', (e) => { e.stopPropagation(); setCardStatus('incorrect'); });
        
        reviewButton.addEventListener('click', toggleReviewMode);

        voiceModeButton.addEventListener('click', () => {
            isVoiceModeActive = !isVoiceModeActive;
            voiceModeButton.classList.toggle('active', isVoiceModeActive);
            if (isVoiceModeActive) {
                voiceModeButton.textContent = 'üîä Voice On';
                startVoiceInteraction();
            } else {
                voiceModeButton.textContent = 'üîä Voice Mode';
                speechSynthesis.cancel();
                if (recognition) recognition.stop();
                speechStatus.textContent = '';
            }
        });

        summaryToggleButton.addEventListener('click', () => {
            const isHidden = summarySection.style.display === 'none';
            if (isHidden) {
                renderSummary();
                summarySection.style.display = 'block';
                summaryToggleButton.textContent = 'Hide Summary';
            } else {
                summarySection.style.display = 'none';
                summaryToggleButton.textContent = 'Summary';
            }
        });

        resetButton.addEventListener('click', () => {
            if (confirm('Are you sure you want to reset all flags and answers?')) {
                shuffleArray(flashcards);
                flashcards.forEach(card => {
                    card.isFlagged = false;
                    card.status = 'unanswered';
                });
                if(reviewMode) toggleReviewMode();
                populateSelect();
                currentCard = 0;
                showCard(currentCard);
                renderSummary();
                updateStats();
            }
        });

        let touchstartX = 0, touchstartY = 0, touchendX = 0;
        const swipeThreshold = 50; 

        function handleSwipe() {
            const deltaX = touchendX - touchstartX;
            if (Math.abs(deltaX) < swipeThreshold) return;
            if (touchendX < touchstartX) nextButton.click();
            if (touchendX > touchstartX) prevButton.click();
        }

        cardElement.addEventListener('touchstart', e => {
            if (e.target.closest('button') || e.target.closest('select')) return;
            touchstartX = e.changedTouches[0].screenX;
            touchstartY = e.changedTouches[0].screenY;
        }, false);

        cardElement.addEventListener('touchmove', e => {
            const moveX = e.changedTouches[0].screenX;
            const moveY = e.changedTouches[0].screenY;
            if (Math.abs(moveX - touchstartX) > Math.abs(moveY - touchstartY)) {
                e.preventDefault();
            }
        }, { passive: false });

        cardElement.addEventListener('touchend', e => {
            if (e.target.closest('button') || e.target.closest('select')) return;
            touchendX = e.changedTouches[0].screenX;
            handleSwipe();
        }, false);

        populateSelect();
        showCard(currentCard);
        updateStats();
        summarySection.style.display = 'none';
    });
</script>
</body>
</html>
